<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Intake — Scanner + Log + Auto‑Redirect</title>
  <style>
    :root { --bg:#0b0b10; --fg:#e8e8ef; --muted:#9aa0a6; --accent:#8ab4f8; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--fg)}
    header{padding:16px 20px;border-bottom:1px solid #222}
    h1{margin:0;font-size:18px}
    main{display:grid;grid-template-columns:1.2fr 1fr;gap:16px;padding:16px}
    .card{background:#111;border:1px solid #222;border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.2)}
    .card h2{margin:0 0 8px 0;font-size:14px;color:var(--muted);font-weight:600;letter-spacing:.4px}
    .card .content{padding:14px}
    #reader{width:100%;min-height:360px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    input[type="text"], input[type="url"], input[type="number"], textarea, select{
      width:100%;padding:10px;border-radius:10px;border:1px solid #2a2a2a;background:#0f0f12;color:var(--fg)
    }
    button{appearance:none;border:1px solid #2a2a2a;background:#0f0f12;color:var(--fg);padding:10px 12px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);color:#081018;border-color:transparent}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid #222;vertical-align:top}
    th{color:var(--muted);font-weight:600;text-align:left}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#1a1f2b;color:#a9c7ff;font-size:11px;border:1px solid #28324a}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .inline{display:flex;align-items:center;gap:10px}
    .right{justify-content:flex-end}
    footer{padding:12px 16px;color:var(--muted);font-size:12px}
    @media (max-width: 1024px){ main{grid-template-columns:1fr;}}
  </style>
  <!-- Library loader tries UNPKG then jsDelivr to avoid CDN blocks -->
  <script>
    function loadQrLib(){
      return new Promise((resolve, reject)=>{
        let done = false;
        function add(src){
          const s = document.createElement('script');
          s.src = src; s.async = true;
          s.onload = ()=>{ if(done) return; done = true; resolve(); };
          s.onerror = ()=>{ /* try next */ next(); };
          document.head.appendChild(s);
        }
        const cdns = [
          'https://unpkg.com/html5-qrcode@2.3.9/html5-qrcode.min.js',
          'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.9/minified/html5-qrcode.min.js'
        ];
        function next(){
          if(!cdns.length){ if(!done) reject(new Error('Failed to load html5-qrcode')); return; }
          add(cdns.shift());
        }
        next();
      });
    }
  </script>
</head>
<body>
  <header>
    <h1>QR Intake <span class="pill">Scanner • Log • Auto‑Redirect</span></h1>
  </header>

  <main>
    <section class="card">
      <div class="content">
        <h2>Scanner</h2>
        <div id="reader"></div>
        <div class="row" style="margin-top:12px">
          <div class="inline" style="gap:8px;flex-wrap:wrap">
            <select id="cameraSelect" style="min-width:220px"></select>
            <button id="startBtn" class="primary">Start camera</button>
            <button id="stopBtn" disabled>Stop</button>
            <span id="status" class="muted">Loading…</span>
          </div>
        </div>
        <div id="diag" class="muted" style="font-size:11px;margin-top:6px"></div>

        <div class="row" style="margin-top:14px">
          <div style="flex:1 1 220px">
            <label>Redirect mode</label>
            <select id="redirectMode">
              <option value="none">No redirect</option>
              <option value="scanned-url">Open scanned URL (same tab)</option>
              <option value="scanned-url-new">Open scanned URL (new tab)</option>
              <option value="template">Template URL (replace {SCAN})</option>
            </select>
          </div>
          <div style="flex:2 1 340px" id="templateWrap">
            <label>Template URL (use {SCAN} where the code should go)</label>
            <input type="url" id="templateUrl" placeholder="https://example.com/checkin?code={SCAN}">
          </div>
          <div style="flex:1 1 160px">
            <label>Redirect delay (ms)</label>
            <input type="number" id="delayMs" value="300" min="0" step="50">
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="content">
        <h2>Log</h2>
        <div class="controls">
          <div class="row">
            <button id="exportCsv">Export CSV</button>
            <button id="copyJson">Copy JSON</button>
            <button id="clearList">Clear</button>
          </div>
          <div class="row right">
            <button id="toggleSound">Sound: On</button>
          </div>
        </div>
        <div style="margin-top:10px;max-height:330px;overflow:auto;border:1px solid #222;border-radius:10px">
          <table id="table">
            <thead><tr><th>#</th><th>Value</th><th class="muted">When</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <p class="muted" style="margin-top:10px">Saved locally (browser storage). Export to keep a copy.</p>
      </div>
    </section>
  </main>

  <footer>
    Tip: For continuous scanning **and** opening destinations, use “Open scanned URL (new tab)” so this page keeps the camera active.
  </footer>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const tableBody = $('#table tbody');
  const camSelect = $('#cameraSelect');
  const startBtn = $('#startBtn');
  const stopBtn  = $('#stopBtn');
  const statusEl = $('#status');
  const diagEl   = $('#diag');
  const redirectMode = $('#redirectMode');
  const templateUrl  = $('#templateUrl');
  const delayMs      = $('#delayMs');
  const exportCsvBtn = $('#exportCsv');
  const copyJsonBtn  = $('#copyJson');
  const clearListBtn = $('#clearList');
  const toggleSoundBtn = $('#toggleSound');
  const templateWrap = $('#templateWrap');

  let scans = loadScans();
  let soundOn = true;
  let lastDecodedAt = 0;
  const DEBOUNCE_MS = 1000; // prevent duplicate rapid fires
  let html5qrcode = null; // instance

  function setStatus(msg){ statusEl.textContent = msg; }
  function setDiag(msg){
    const secure = window.isSecureContext ? 'secure' : 'insecure';
    const hasMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
    diagEl.textContent = `[${secure}] mediaDevices:${hasMedia?'yes':'no'} ${msg||''}`;
  }

  function loadScans(){
    try{ return JSON.parse(localStorage.getItem('qr_scans_v2')||'[]'); }catch(e){ return []; }
  }
  function saveScans(){ localStorage.setItem('qr_scans_v2', JSON.stringify(scans)); }

  function render(){
    tableBody.innerHTML = '';
    scans.forEach((row,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td><td>${escapeHtml(row.value)}</td><td class="muted">${new Date(row.ts).toLocaleString()}</td>`;
      tableBody.appendChild(tr);
    });
  }

  function exportCsv(){
    const lines = [['index','value','timestamp_iso']] 
      .concat(scans.map((r,i)=>[i+1, r.value, new Date(r.ts).toISOString()]));
    const csv = lines
      .map(row => row.map(cell => `"${String(cell).replace(/\"/g,'""')}"`).join(','))
      .join('
');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'qr-scans.csv'; a.click();
    URL.revokeObjectURL(url);
  }

  function copyJson(){
    navigator.clipboard.writeText(JSON.stringify(scans, null, 2)).then(()=>{
      flashButton(copyJsonBtn);
    });
  }

  function clearList(){
    if(!confirm('Clear all scans?')) return;
    scans = []; saveScans(); render();
  }

  function flashButton(btn){
    const old = btn.textContent; btn.textContent = '✓';
    setTimeout(()=>btn.textContent = old, 700);
  }

  function beep(){
    if(!soundOn) return;
    try{
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type='square'; o.frequency.setValueAtTime(880, ctx.currentTime);
      g.gain.setValueAtTime(0.05, ctx.currentTime);
      o.connect(g).connect(ctx.destination);
      o.start(); setTimeout(()=>{o.stop(); ctx.close()}, 120);
    }catch(e){}
  }

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  toggleSoundBtn.addEventListener('click',()=>{
    soundOn = !soundOn; toggleSoundBtn.textContent = 'Sound: ' + (soundOn? 'On':'Off');
  });
  exportCsvBtn.addEventListener('click', exportCsv);
  copyJsonBtn.addEventListener('click', copyJson);
  clearListBtn.addEventListener('click', clearList);
  redirectMode.addEventListener('change', ()=>{ templateWrap.style.display = (redirectMode.value === 'template') ? 'block':'none'; });
  templateWrap.style.display = 'none';

  render();
  setStatus('Loading library…'); setDiag('init');

  // Load library, then prepare UI
  loadQrLib().then(()=>{
    setStatus('Preparing camera…');
    prepare();
  }).catch(err=>{
    setStatus('Failed to load scanner library'); setDiag(String(err));
  });

  async function prepare(){
    // Preflight to unlock enumerateDevices / labels on Safari
    try{
      await navigator.mediaDevices.getUserMedia({ video: true }).then(s => s.getTracks().forEach(t=>t.stop()));
    }catch(e){ /* user might deny here; they can still hit Start */ }

    // Populate device list
    try{
      const cams = (await Html5Qrcode.getCameras()) || [];
      camSelect.innerHTML = '';
      if (!cams.length){ setStatus('No cameras found. Tap Start and allow.'); return; }
      cams.forEach((c,i)=>{
        const opt = document.createElement('option');
        opt.value = c.id; opt.textContent = c.label || `Camera ${i+1}`; camSelect.appendChild(opt);
      });
      const back = cams.find(c => /back|rear|environment/i.test(c.label||''));
      if (back) camSelect.value = back.id;
      setStatus('Ready'); setDiag('devices:'+cams.length);
    }catch(err){ setStatus('Camera permission blocked. Tap Start and allow.'); }
  }

  async function start(){
    try{
      setStatus('Starting…'); setDiag('starting');
      const config = { fps: 10, qrbox: 280, experimentalFeatures: { useBarCodeDetectorIfSupported: true } };
      if (!html5qrcode){ html5qrcode = new Html5Qrcode('reader', { verbose: false }); }

      const selectedId = camSelect && camSelect.value ? { deviceId: { exact: camSelect.value } } : null;
      try {
        if (selectedId){ await html5qrcode.start(selectedId, config, onDecoded); }
        else { await html5qrcode.start({ facingMode: { exact: 'environment' } }, config, onDecoded); }
      } catch(e1){
        try { await html5qrcode.start({ facingMode: 'environment' }, config, onDecoded); }
        catch(e2){ await html5qrcode.start({ facingMode: 'user' }, config, onDecoded); }
      }

      setStatus('Scanning…'); setDiag('running');
      startBtn.disabled = true; stopBtn.disabled = false; camSelect.disabled = true;
    }catch(err){
      console.error('start error', err);
      alert('Could not start camera :(

Fixes to try:
• In browser permissions, allow Camera for this site.
• On iPhone: Settings → Safari → Camera → Allow.
• If using Private/Incognito, switch to a normal tab.');
      setStatus('Blocked'); setDiag(err && (err.name+': '+err.message));
    }
  }

  async function stop(){
    try{
      if (html5qrcode){ await html5qrcode.stop(); await html5qrcode.clear(); }
      startBtn.disabled = false; stopBtn.disabled = true; camSelect.disabled = false; setStatus('Stopped'); setDiag('stopped');
    }catch(err){ console.error(err); }
  }

  function handleRedirect(decodedText){
    const mode = redirectMode.value;
    const delay = Math.max(0, parseInt(delayMs.value||'0',10));
    function isUrl(s){ try{ new URL(s.startsWith('http')? s : ('https://'+s)); return true;}catch(e){ return false; } }

    if (mode === 'scanned-url' || mode === 'scanned-url-new'){
      if (!isUrl(decodedText)) return;
      const url = decodedText.startsWith('http')? decodedText : ('https://'+decodedText);
      setTimeout(()=>{ if (mode === 'scanned-url-new') window.open(url,'_blank'); else window.location.assign(url); }, delay);
    } else if (mode === 'template'){
      const tpl = (templateUrl.value||'').trim(); if (!tpl || !tpl.includes('{SCAN}')) return;
      const url = tpl.replaceAll('{SCAN}', encodeURIComponent(decodedText));
      setTimeout(()=>{ window.location.assign(url); }, delay);
    }
  }

  function onDecoded(decodedText){
    const now = Date.now();
    if (now - lastDecodedAt < DEBOUNCE_MS) return; // debounce duplicates
    lastDecodedAt = now;

    scans.unshift({ value: decodedText, ts: now });
    saveScans(); render(); beep();
    if (navigator.vibrate) navigator.vibrate(35);

    handleRedirect(decodedText);
  }

  // wire buttons
  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
})();
</script>
</body>
</html>
